// src/hooks/use-project-chat.ts
"use client";

import { useState, useCallback } from "react";

export type Message = {
  id: string;
  role: "user" | "assistant";
  content: string;
};

export function useProjectChat(initialMessages: Message[] = []) {
  const [messages, setMessages] = useState<Message[]>(initialMessages);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setInput(e.target.value);
  };

  const append = useCallback(
    async (message: { role: "user"; content: string }) => {
      setIsLoading(true);

      // 1. Tambah pesan user ke state UI langsung
      const userMsg: Message = {
        id: Date.now().toString(),
        role: "user",
        content: message.content,
      };

      // Optimistic update
      setMessages((prev) => [...prev, userMsg]);

      try {
        // 2. Siapkan pesan placeholder buat bot
        const botMsgId = (Date.now() + 1).toString();
        setMessages((prev) => [
          ...prev,
          { id: botMsgId, role: "assistant", content: "" }, // Konten kosong dulu
        ]);

        // 3. Hit API
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // Kirim seluruh history chat biar bot punya konteks
          body: JSON.stringify({
            messages: [...messages, userMsg].map(({ role, content }) => ({
              role,
              content,
            })),
          }),
        });

        if (!response.ok) throw new Error("API Error");
        if (!response.body) throw new Error("No response body");

        // 4. Baca Stream (Reader Logic)
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let accumulatedText = "";

        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;

          if (value) {
            const chunk = decoder.decode(value, { stream: true });
            accumulatedText += chunk;

            // Update pesan bot secara real-time
            setMessages((prev) =>
              prev.map((msg) =>
                msg.id === botMsgId ? { ...msg, content: accumulatedText } : msg
              )
            );
          }
        }
      } catch (error) {
        console.error("Chat Error:", error);
        // Optional: Kasih feedback error ke UI
      } finally {
        setIsLoading(false);
      }
    },
    [messages]
  );

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;
    const val = input;
    setInput("");
    await append({ role: "user", content: val });
  };

  return {
    messages,
    input,
    setInput,
    handleInputChange,
    handleSubmit,
    append,
    isLoading,
  };
}
